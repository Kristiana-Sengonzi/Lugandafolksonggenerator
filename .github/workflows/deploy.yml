
name: Modal CI/CD Deploy
# This is the CI/CD workflow that runs every time code is pushed to the 'main' branch.

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    name: Deploy to Modal
    runs-on: ubuntu-latest
    
    # Inject the Modal authentication tokens as environment variables
    env:
      MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      # Use setup-python with caching to ensure a stable environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 
        cache: 'pip'
        
    - name: Install Modal CLI
      # Upgrade pip and install the Modal package
      run: |
        python -m pip install --upgrade pip
        pip install modal
      
    - name: Run Modal Deploy
      # This is the core command. If it fails (due to Auth or a code error), 
      # the job will automatically stop and display the error message from the Modal CLI.
      run: modal deploy modal_app.py